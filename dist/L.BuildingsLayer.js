(function(h){function J(m){for(var o=0,s=0,e=0,f=m.length-3;e<f;e+=2){o+=m[e];s+=m[e+1]}m=(m.length-2)*2;return[o/m<<0,s/m<<0]}function ya(m){var o=m.length/2,s=new za(o),e=0,f=o-1,j,n,l,w,D=[],K=[],F=[];for(s[e]=s[f]=1;f;){n=0;for(j=e+1;j<f;j++){l=m[j*2];var M=m[j*2+1],P=m[e*2],x=m[e*2+1],E=m[f*2],Q=m[f*2+1],z=E-P,p=Q-x,u=void 0;if(z!==0||p!==0){u=((l-P)*z+(M-x)*p)/(z*z+p*p);if(u>1){P=E;x=Q}else if(u>0){P+=z*u;x+=p*u}}z=l-P;p=M-x;l=z*z+p*p;if(l>n){w=j;n=l}}if(n>2){s[w]=1;D.push(e);K.push(w);D.push(w);
K.push(f)}e=D.pop();f=K.pop()}for(j=0;j<o;j++)s[j]&&F.push(m[j*2],m[j*2+1]);return F}var Aa=Aa||Array,za=za||Array,ba=Math,La=ba.exp,Ma=ba.log,Ba=ba.tan,Na=ba.atan,da=ba.min,sa=ba.max,ma=h.document,R=function(){function m(e,f,j){if(j<0)j+=1;if(j>1)j-=1;if(j<1/6)return e+(f-e)*6*j;if(j<0.5)return f;if(j<2/3)return e+(f-e)*(2/3-j)*6;return e}function o(e,f,j,n){this.r=e;this.g=f;this.b=j;this.a=arguments.length<4?1:n}var s=o.prototype;s.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<
0,this.a.toFixed(2)].join(",")+")"};s.adjustLightness=function(e){var f=R.toHSLA(this);f.l*=e;f.l=Math.min(1,Math.max(0,f.l));var j,n;if(f.s===0)e=j=n=f.l;else{n=f.l<0.5?f.l*(1+f.s):f.l+f.s-f.l*f.s;var l=2*f.l-n;e=m(l,n,f.h+1/3);j=m(l,n,f.h);n=m(l,n,f.h-1/3)}return new R(e*255<<0,j*255<<0,n*255<<0,f.a)};s.adjustAlpha=function(e){return new R(this.r,this.g,this.b,this.a*e)};o.parse=function(e){e+="";if(~e.indexOf("#")){e=e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new R(parseInt(e[1],16),parseInt(e[2],
16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new R(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};o.toHSLA=function(e){var f=e.r/255,j=e.g/255,n=e.b/255,l=Math.max(f,j,n),w=Math.min(f,j,n),D,K=(l+w)/2,F;if(l===w)D=w=0;else{F=l-w;w=K>0.5?F/(2-l-w):F/(l+w);switch(l){case f:D=(j-n)/F+(j<n?6:0);break;case j:D=(n-f)/F+2;break;case n:D=(f-j)/F+4;break}D/=6}return{h:D,s:w,l:K,a:e.a}};return o}();
(function(){var m=Math,o=m.sin,s=m.cos,e=m.tan,f=m.asin,j=m.atan2,n=m.PI,l=180/n,w=357.5291/l,D=0.98560028/l,K=1.9148/l,F=0.02/l,M=3.0E-4/l,P=102.9372/l,x=23.45/l,E=280.16/l,Q=360.9856235/l;return function(z,p,u){u=-u/l;p=p/l;z=z.valueOf()/864E5-0.5+2440588;var v=w+D*(z-2451545),N=K*o(v)+F*o(2*v)+M*o(3*v);N=v+P+N+n;v=f(o(N)*o(x));N=j(o(N)*s(x),s(N));u=E+Q*(z-2451545)-u-N;return{altitude:f(o(p)*o(v)+s(p)*s(v)*s(u)),azimuth:j(o(u),s(u)*o(p)-e(v)*s(p))-n/2}}})();var ea=Math.PI,Ca=ea/2,Oa=ea/4,Pa=180/
ea,Qa=256,ta=14,fa="latitude",ga="longitude",V=0,U=1,S=2,W=3,Da=4,ha=5,ia=6;h.OSMBuildings=function(m){function o(a,c){var b={};a/=N;c/=N;b[fa]=c<=0?90:c>=1?-90:Pa*(2*Na(La(ea*(1-2*c)))-Ca);b[ga]=(a===1?1:(a%1+1)%1)*360-180;return b}function s(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function e(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",
a);b.send(null);return b}function f(){if(!(!ua||v<ta)){var a=o(p-Q,u-z),c=o(p+x+Q,u+E+z);na&&na.abort();na=e(s(ua,{w:a[ga],n:a[fa],e:c[ga],s:c[fa],z:v}),j)}}function j(a){var c,b,d,g=[],i,k=i=0;oa=ta;K(v);na=null;if(!(!a||a.meta.z!==v)){d=a.meta;b=a.data;if(G&&A&&G.z===d.z){i=G.x-d.x;k=G.y-d.y;a=0;for(c=A.length;a<c;a++)g[a]=A[a][S][0]+i+","+(A[a][S][1]+k)}G=d;A=[];a=0;for(c=b.length;a<c;a++){d=[];if(!(b[a][U]>ja)){i=ya(b[a][S]);if(!(i.length<8)){d[S]=i;d[Da]=J(i);d[V]=da(b[a][V],ja);d[U]=b[a][U];
i=d[S][0]+","+d[S][1];d[ha]=!(g&&~g.indexOf(i));d[W]=[];d[ia]=[];A.push(d)}}}F()}}function n(a,c){var b=[],d,g,i,k,y,q,r,O,t,H=va-v;d=0;for(g=a.length;d<g;d++){y=a[d];O=y[U]>>H;if(!(O>ja)){q=y[S];t=new Aa(q.length);i=0;for(k=q.length-1;i<k;i+=2){r=q[i+1];var I=da(1,sa(0,0.5-Ma(Ba(Oa+Ca*q[i]/180))/ea/2));r={x:(r/360+0.5)*N<<0,y:I*N<<0};t[i]=r.x;t[i+1]=r.y}t=ya(t);if(!(t.length<8)){k=[];k[S]=t;k[Da]=J(t);k[V]=da(y[V]>>H,ja);k[U]=O;k[ha]=c;k[W]=y[W];k[ia]=[];for(i=0;i<3;i++)if(k[W][i])k[ia][i]=k[W][i].adjustAlpha(T)+
"";b.push(k)}}}return b}function l(a,c){if(typeof a==="object")D(a,!c);else{var b=ma.documentElement,d=ma.createElement("script");h.jsonpCallback=function(g){delete h.jsonpCallback;b.removeChild(d);D(g,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function w(a,c,b){if(b===undefined)b=[];var d,g,i,k=a[0]?a:a.features,y,q,r,O,t,H=c?1:0,I=c?0:1;if(k){d=0;for(a=k.length;d<a;d++)w(k[d],c,b);return b}if(a.type==="Feature"){y=a.geometry;d=a.properties}if(y.type==="Polygon")q=
[y.coordinates];if(y.type==="MultiPolygon")q=y.coordinates;if(q){c=d.height;if(d.color||d.wallColor)O=R.parse(d.color||d.wallColor);if(d.roofColor)t=R.parse(d.roofColor);d=0;for(a=q.length;d<a;d++){k=q[d][0];r=[];g=y=0;for(i=k.length;g<i;g++){r.push(k[g][H],k[g][I]);y+=c||k[g][2]||0}if(y){g=[];i=S;var B=void 0,Z=void 0,Ea=void 0,Fa=void 0,Ga=0,$=void 0,Ha=void 0;$=0;for(Ha=r.length-3;$<Ha;$+=2){B=r[$];Z=r[$+1];Ea=r[$+2];Fa=r[$+3];Ga+=B*Fa-Ea*Z}if((Ga/2>0?"CW":"CCW")==="CW")r=r;else{B=[];for(Z=r.length-
2;Z>=0;Z-=2)B.push(r[Z],r[Z+1]);r=B}g[i]=r;g[V]=y/k.length<<0;g[W]=[O||null,O?O.adjustLightness(0.8):null,t?t:O?O.adjustLightness(1.2):aa];b.push(g)}}}return b}function D(a,c){if(a){ka=w(a,c);oa=0;K(v);G={n:90,w:-180,s:-90,e:180,x:0,y:0,z:v};A=n(ka,true);F()}else{ka=null;M()}}function K(a){var c,b,d;v=a;N=Qa<<v;a=v;c=oa;b=va;a=da(sa(a,c),b);T=1-da(sa(0+(a-c)/(b-c)*0.4,0),0.4);Ia=X.adjustAlpha(T)+"";Ja=pa.adjustAlpha(T)+"";la=aa.adjustAlpha(T)+"";if(A){a=0;for(c=A.length;a<c;a++){d=A[a];d[ia]=[];for(b=
0;b<3;b++)if(d[W][b])d[ia][b]=d[W][b].adjustAlpha(T)+""}}}function F(){clearInterval(wa);ca=0;wa=setInterval(function(){ca+=0.1;if(ca>1){clearInterval(wa);ca=1;for(var a=0,c=A.length;a<c;a++)A[a][ha]=0}M()},33)}function M(){C.clearRect(0,0,x,E);C.fillStyle="rgba(0,0,0)";C.fillRect(0,0,x,E);if(!(!G||!A||v<oa||xa)){var a,c,b,d,g,i,k,y,q,r=p-G.x,O=u-G.y,t,H,I,B;a=0;for(c=A.length;a<c;a++){g=A[a];H=false;i=g[S];t=[];b=0;for(d=i.length-1;b<d;b+=2){t[b]=k=i[b]-r;t[b+1]=q=i[b+1]-O;H||(H=k>0&&k<x&&q>0&&q<
E)}if(H){b=g[ha]?g[V]*ca:g[V];k=Y/(Y-b);if(g[U]){b=g[ha]?g[U]*ca:g[U];y=Y/(Y-b)}i=[];b=0;for(d=t.length-3;b<d;b+=2){q=t[b];I=t[b+1];H=P(q,I,k);B=P(q,I,Y/(Y-40));B=C.createLinearGradient(q,I,B.x,B.y);B.addColorStop(0,"rgba(64,64,64,0.7)");B.addColorStop(0.4,"rgba(50,70,50,0.8)");B.addColorStop(0.6,"rgba(50,120,100,0.9)");B.addColorStop(0.8,"rgb(170,50,150)");B.addColorStop(1,"rgb(255,0,0)");C.strokeStyle=B;if(g[U]){I=P(q,I,y);q=I.x;I=I.y}C.beginPath();C.moveTo(q,I);C.lineTo(H.x,H.y);C.stroke();i[b]=
H.x;i[b+1]=H.y}g=g[V]/40;la=g<0.2?"rgba(64,64,64,0.7)":g<0.4?"rgba(50,70,50,0.8)":g<0.6?"rgba(50,120,100,0.9)":g<0.8?"rgb(170,50,150)":"rgb(255,0,0)";C.strokeStyle=la;if(i.length){C.beginPath();C.moveTo(i[0],i[1]);g=2;for(t=i.length;g<t;g+=2)C.lineTo(i[g],i[g+1]);C.closePath();C.stroke()}}}}}function P(a,c,b){return{x:(a-qa)*b+qa<<0,y:(c-ra)*b+ra<<0}}var x=0,E=0,Q=0,z=0,p=0,u=0,v,N,na,C,ua,X=new R(200,190,180),pa=X.adjustLightness(0.8),aa=X.adjustLightness(1.2),Ia=X+"",Ja=pa+"",la=aa+"",ka,G,A,ca=
1,wa,T=1,oa=ta,va=20,ja,qa,ra,Y,xa,Ka={container:null,items:[],init:function(a){var c=this.container=ma.createElement("DIV");c.style.pointerEvents="none";c.style.position="absolute";c.style.left=0;c.style.top=0;C=this.create();a.appendChild(c);return c},create:function(){var a=ma.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var c=a.getContext("2d");c.lineCap="round";c.lineJoin="round";
c.lineWidth=2;try{c.mozImageSmoothingEnabled=false}catch(b){}this.items.push(a);this.container.appendChild(a);return c},setSize:function(a,c){for(var b=this.items,d=0,g=b.length;d<g;d++){b[d].width=a;b[d].height=c}}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){X=R.parse(a.color||a.wallColor);Ia=X.adjustAlpha(T)+"";pa=X.adjustLightness(0.8);Ja=pa.adjustAlpha(T)+"";aa=X.adjustLightness(1.2);la=aa.adjustAlpha(T)+""}if(a.roofColor){aa=R.parse(a.roofColor);la=aa.adjustAlpha(T)+""}M();
return this};this.geoJSON=function(a,c){l(a,c);return this};this.setCamOffset=function(a,c){qa=Q+a;ra=E+c};this.setMaxZoom=function(a){va=a};this.setDate=function(){return this};this.appendTo=function(a){return Ka.init(a)};this.loadData=f;this.onMoveEnd=function(){var a=o(p,u),c=o(p+x,u+E);M();if(G&&(a[fa]>G.n||a[ga]<G.w||c[fa]<G.s||c[ga]>G.e))f()};this.onZoomEnd=function(a){xa=false;K(a.zoom);if(ka){A=n(ka);M()}else{M();f()}};this.onZoomStart=function(){xa=true;M()};this.setOrigin=function(a,c){p=
a;u=c};this.setSize=function(a,c){x=a;E=c;Q=x/2<<0;z=E/2<<0;qa=Q;ra=E;Y=x/((window.devicePixelRatio||1)*1.5)/Ba(45)<<0;Ka.setSize(x,E);ja=Y-50};this.setZoom=K;this.render=M;ua=m};h.OSMBuildings.VERSION="0.1.8a";h.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,container:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(h){L.Util.setOptions(this,h)},onMove:function(){var h=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-h.x,this.lastY-h.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var h=L.DomUtil.getPosition(this.map._mapPane),J=this.map.getPixelOrigin();this.lastX=h.x;this.lastY=h.y;this.container.style.left=-h.x+
"px";this.container.style.top=-h.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(J.x-h.x,J.y-h.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var h=L.DomUtil.getPosition(this.map._mapPane),J=this.map.getPixelOrigin();this.osmb.setOrigin(J.x-h.x,J.y-h.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(h){h.addLayer(this);return this},onAdd:function(h){this.map=
h;h=this.map._panes.overlayPane;if(this.osmb)h.appendChild(this.container);else{this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.appendTo(h);this.osmb.maxZoom=this.map._layersMaxZoom}h=L.DomUtil.getPosition(this.map._mapPane);var J=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(J.x-h.x,J.y-h.y);this.osmb.setZoom(this.map._zoom);this.container.style.left=-h.x+"px";this.container.style.top=-h.y+"px";this.map.on({move:this.onMove,
moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(h){h.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);h.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.container.parentNode.removeChild(this.container)},geoJSON:function(h,J){return this.osmb.geoJSON(h,J)},setStyle:function(h){return this.osmb.setStyle(h)},
setDate:function(h){return this.osmb.setDate(h)}});
